# Go TML Builder

Генератор грамматики TextMate для языка 1С (BSL) на Go.

## Описание

Этот проект представляет собой генератор грамматики TextMate для языка 1С (BSL), который создает файл `bsl.tmLanguage.json` для подсветки синтаксиса в редакторе VS Code.

## Структура проекта

```
go-tml-builder/
├── cmd/
│   └── tml-builder/
│       └── main.go                 # Точка входа приложения
├── internal/
│   ├── core/
│   │   ├── generator/
│   │   │   ├── builder.go          # Построитель грамматики
│   │   │   └── grammar.go          # Генерация и сохранение
│   │   ├── models/
│   │   │   ├── schema.go           # Основные модели данных
│   │   │   └── repository.go       # Репозиторий правил
│   │   └── regexputil/
│   │       └── expressions.go      # Утилиты для регулярных выражений
│   └── providers/
│       └── bsl/
│           ├── models/
│           │   ├── keywords.go     # Ключевые слова BSL
│           │   └── repository_keys.go # Ключи репозитория
│           ├── rules/
│           │   ├── rules.go        # Основные правила
│           │   ├── comments.go     # Правила комментариев
│           │   ├── control_flow.go # Управление потоком
│           │   ├── functions.go    # Функции и процедуры
│           │   ├── operators.go    # Операторы
│           │   ├── variables.go    # Переменные и аннотации
│           │   ├── blocks.go       # Блоки кода
│           │   ├── strings.go      # Строковые литералы
│           │   ├── support_types.go # Поддерживаемые типы
│           │   ├── regions.go      # Области кода
│           │   └── documentation.go # Документация функций
│           └── provider.go         # Основной провайдер BSL
├── old_tml/
│   └── bsl.tmLanguage.json         # Исходный файл грамматики
├── examples/
│   └── dynamic_regex_example.go    # Пример использования ExpressionOrFunc
├── docs/
│   └── dynamic_regex_approach.md   # Документация по динамическим регулярным выражениям
└── bsl.tmLanguage.json             # Сгенерированный файл
```

## Возможности

### Поддерживаемые элементы языка:

1. **Ключевые слова управления потоком**
   - `Если`, `Тогда`, `Иначе`, `ИначеЕсли`, `КонецЕсли`
   - `Для`, `Каждого`, `Из`, `Цикл`, `КонецЦикла`, `Пока`
   - `Попытка`, `Исключение`, `КонецПопытки`, `ВызватьИсключение`
   - `Возврат`, `Продолжить`, `Прервать`

2. **Функции и процедуры**
   - `Функция`, `Процедура`, `КонецФункции`, `КонецПроцедуры`
   - Параметры функций
   - Модификатор `Экспорт`

3. **Переменные и типы**
   - `Перем` - объявление переменных
   - Поддерживаемые типы: `Строка`, `Число`, `Дата`, `Булево`
   - Универсальные типы: `Структура`, `Массив`, `Соответствие`, `ТаблицаЗначений`

4. **Операторы**
   - Арифметические: `+`, `-`, `*`, `/`, `%`
   - Сравнения: `=`, `<>`, `<`, `>`, `<=`, `>=`
   - Логические: `И`, `ИЛИ`, `НЕ`

5. **Комментарии**
   - Однострочные: `//`
   - Блоки комментариев
   - Комментарии разработчика: `// +++`, `// ---`, `// >>>`, `// <<<`

6. **Строковые литералы**
   - Строки в кавычках
   - Экранирование кавычек: `""`
   - Параметры строковых шаблонов: `%1`, `%2`

7. **Константы**
   - `Истина`, `Ложь`, `Неопределено`, `Null`
   - Числовые литералы
   - Даты: `'20250101'`

8. **Встроенные функции**
   - Строковые: `СтрДлина`, `ВРег`, `НРег`, `СтрНайти`
   - Математические: `Цел`, `Окр`, `Sin`, `Cos`
   - Работа с датами: `Год`, `Месяц`, `День`, `ТекущаяДата`
   - Диалоги: `ПоказатьВопрос`, `Сообщить`
   - Работа с файлами: `КопироватьФайл`, `НайтиФайлы`
   - Работа с ИБ: `НачатьТранзакцию`, `ЗафиксироватьТранзакцию`

9. **Области кода**
   - `#Область ИмяОбласти`
   - `#КонецОбласти`

10. **Аннотации**
    - `&НаКлиенте`, `&НаСервере`, `&НаКлиентеНаСервере`
    - Пользовательские аннотации: `&ИмяАннотации`

11. **Документация функций**
    - Блоки параметров: `// Параметры:`
    - Блоки возвращаемых значений: `// Возвращаемое значение:`
    - Описание параметров: `// * Имя - Тип - описание`

## Использование

### Сборка и запуск

```bash
# Клонирование репозитория
git clone <repository-url>
cd go-tml-builder

# Запуск генератора
go run cmd/tml-builder/main.go
```

После выполнения будет создан файл `bsl.tmLanguage.json` в корневой директории проекта.

### Установка в VS Code

1. Скопируйте сгенерированный файл `bsl.tmLanguage.json` в папку расширения
2. Добавьте в `package.json` расширения:

```json
{
  "contributes": {
    "languages": [{
      "id": "bsl",
      "aliases": ["1C", "BSL"],
      "extensions": [".bsl", ".os"],
      "configuration": "./language-configuration.json"
    }],
    "grammars": [{
      "language": "bsl",
      "scopeName": "source.bsl",
      "path": "./bsl.tmLanguage.json"
    }]
  }
}
```

## Архитектура

### Основные компоненты:

1. **Core Models** (`internal/core/models/`)
   - `Rule` - базовое правило грамматики
   - `Grammar` - полная грамматика
   - `Repository` - хранилище именованных правил

2. **BSL Provider** (`internal/providers/bsl/`)
   - `BslProvider` - основной провайдер для языка BSL
   - Модульная структура правил по категориям

3. **Generator** (`internal/core/generator/`)
   - `GrammarBuilder` - построитель грамматики
   - Функции для сохранения в JSON

4. **Regex Utilities** (`internal/core/regexputil/`)
   - `ExpressionOrFunc` - динамическое формирование регулярных выражений
   - Поддержка препроцессоров для экранирования и модификации

### Принципы проектирования:

- **Модульность**: правила разделены по функциональности
- **Расширяемость**: легко добавлять новые правила и типы
- **Переиспользование**: правила могут ссылаться друг на друга
- **Типобезопасность**: использование типизированных ключей репозитория
- **Динамические регулярные выражения**: использование `ExpressionOrFunc` для формирования паттернов из литералов

### Динамическое формирование регулярных выражений

Проект использует инновационный подход к формированию регулярных выражений с помощью функции `ExpressionOrFunc`. Вместо жестко заданных паттернов:

```go
// Старый подход
Match: `\b(Если|Тогда|ИначеЕсли|Иначе|КонецЕсли)\b`

// Новый подход с константами
Match: fmt.Sprintf(`(?i:%s(%s)%s)`,
    bslm.WordBoundaryLookBehind,
    regexputil.ExpressionOrFunc(bslm.AllControlKeywords(), nil),
    bslm.WordBoundaryLookAhead)
```

**Преимущества:**
- Централизованное управление ключевыми словами
- Автоматическое обновление при изменении ключевых слов
- Меньше ошибок и опечаток
- Лучшая читаемость и поддерживаемость кода

### Константы регулярных выражений

Для улучшения читаемости и поддерживаемости кода, часто используемые **сложные** паттерны регулярных выражений вынесены в константы в файле `internal/providers/bsl/models/regex_patterns.go`.

**Принцип:** Выносим в константы только сложные паттерны, которые часто повторяются и могут меняться. Простые символы (`^`, `$`, `"`, `//`, `,`, `;`, `=`, `?`, `%` и т.д.) используются напрямую для лучшей читаемости.

**Основные категории констант:**
- **Границы слов**: `WordBoundary`, `WordBoundaryLookBehind`, `WordBoundaryLookAhead`
- **Идентификаторы**: `Identifier`, `IdentifierWithCyrillic`, `IdentifierWithCyrillicCaseInsensitive`
- **Литералы**: `NumericLiteral`, `DateLiteral`, `EscapedQuote`
- **Специальные паттерны**: `StatementEnd`, `CaseInsensitiveWordBoundary`

**Пример использования:**
```go
// Старый подход
Match: `(?i:(?<=[^\wа-яё\.]|^)(Если)(?=[^\wа-яё\.]|$))`
Begin: `(?i:(?<=;|^)\s*(Если))`

// Новый подход - только для сложных паттернов
Match: fmt.Sprintf(`(?i:%s(%s)%s)`, 
    bslm.WordBoundaryLookBehind, "Если", bslm.WordBoundaryLookAhead)
Begin: `(?i:(?<=;|^)\s*(Если))`  // Простые символы напрямую
```

Подробная документация по константам доступна в [docs/regex_patterns_constants.md](docs/regex_patterns_constants.md).

## Разработка

### Добавление новых правил:

1. Создайте новый файл в `internal/providers/bsl/rules/`
2. Добавьте ключ в `internal/providers/bsl/models/repository_keys.go`
3. Реализуйте функцию создания правила
4. Добавьте правило в провайдер (`internal/providers/bsl/provider.go`)

### Пример добавления нового правила:

```go
// В repository_keys.go
const KeyNewRule models.RepositoryKey = "newRule"

// В новом файле rules/new_rule.go
func NewRule() *models.Rule {
    return &models.Rule{
        Key: bslm.KeyNewRule,
        Name: "new.rule.bsl",
        Match: `\bновое_правило\b`,
    }
}

// В provider.go
rule = bslRules.NewRule()
repo[rule.Key] = rule
```

## Примеры

### Динамическое формирование регулярных выражений

Запустите пример для демонстрации работы `ExpressionOrFunc`:

```bash
go run examples/dynamic_regex_example.go
```

Этот пример показывает, как формируются регулярные выражения для:
- Ключевых слов управления потоком
- Логических операторов
- Операторов сравнения и арифметики
- Констант языка

### Константы регулярных выражений

Запустите пример для демонстрации всех доступных констант:

```bash
go run examples/regex_patterns_demo.go
```

Этот пример показывает:
- Все доступные константы и их значения
- Примеры использования в контексте
- Шаблоны для часто используемых конструкций

### Документация

- Подробная документация по подходу к динамическим регулярным выражениям находится в файле `docs/dynamic_regex_approach.md`
- Документация по константам регулярных выражений находится в файле `docs/regex_patterns_constants.md`

## Тестирование

Для тестирования грамматики создайте файл с расширением `.bsl` и проверьте подсветку синтаксиса в поддерживаемом редакторе.

Пример тестового файла: `test.bsl`

## Вклад в проект

1. Форкните репозиторий
2. Создайте ветку для новой функции
3. Внесите изменения
4. Добавьте тесты
5. Создайте Pull Request
